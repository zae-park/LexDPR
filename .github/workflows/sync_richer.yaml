name: π”„ Auto Mirror to Organization Repo

on:
  push:
    branches:
      - '**'
    tags:
      - '**'

jobs:
  mirror_repo:
    runs-on: ubuntu-latest
    
    steps:
      - name: π“¥ Checkout Source Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: π” Verify Token
        env:
          ORG_TOKEN: ${{ secrets.ORG_REPO_TOKEN }}
        run: |
          if [ -z "$ORG_TOKEN" ]; then
            echo "β ORG_REPO_TOKEN is not set"
            echo "Please add the token to repository secrets"
            exit 1
          fi
          echo "β… Token is set (length: ${#ORG_TOKEN})"

      - name: π”— Test Repository Access
        env:
          ORG_TOKEN: ${{ secrets.ORG_REPO_TOKEN }}
        run: |
          TARGET_REPO="github.com/richer4p/LexDPR.git"
          
          echo "Testing access to https://${TARGET_REPO}"
          
          # μƒμ„Έν• μ—λ¬ μ¶λ ¥
          if ! git ls-remote "https://zae-park:${ORG_TOKEN}@${TARGET_REPO}" 2>&1; then
            echo ""
            echo "β Failed to access repository"
            echo ""
            echo "Possible causes:"
            echo "1. Token doesn't have 'repo' scope"
            echo "2. Token expired or invalid"
            echo "3. Repository doesn't exist or is private without access"
            echo "4. Username 'zae-park' is incorrect"
            echo ""
            echo "Please verify:"
            echo "- Token has full 'repo' permissions"
            echo "- Token is not expired"
            echo "- Repository exists: https://${TARGET_REPO}"
            exit 1
          fi
          
          echo "β… Repository access successful"

      - name: π”— Mirror to Organization Repo
        env:
          ORG_TOKEN: ${{ secrets.ORG_REPO_TOKEN }}
        run: |
          TARGET_REPO="github.com/richer4p/LexDPR.git"
          NEW_REMOTE="https://zae-park:${ORG_TOKEN}@${TARGET_REPO}"
          
          echo "Mirroring to: https://${TARGET_REPO}"
          
          git remote add org-mirror "$NEW_REMOTE"
          git push org-mirror --mirror
          
          echo "β… Mirroring complete"